{% extends "base.html" %}
{% load static %}

{% block og_title %}Login - Quesec Bikes{% endblock %}
{% block title %}Login - Quesec Bikes{% endblock %}
{% block og_description %}Quesec Bikes Have Best Bicycle in India{% endblock %}
{% block description %}Quesec Bikes Have Best Bicycle in India{% endblock %}

{% block content %}

        <!-- page-title -->
        <div class="tf-page-title">
            <div class="container-full">
                <div class="heading text-center">Login</div>
            </div>
        </div>
        <!-- /page-title -->

        <!-- page-cart -->
        <section class="flat-spacing-10">
            <div class="container">
                <div class="tf-grid-layout lg-col-2 tf-login-wrap">
                    <div class="tf-login-form">
                        <!-- OTP VERIFY BLOCK (hidden by default) -->
                        <div id="otpBlock" class="is-hidden" aria-hidden="true">
                            <h5 class="mb_24">Enter OTP</h5>
                            <p class="mb_30">We sent an email with the OTP.</p>
                            <div>
                                <form id="verifyOtpForm" method="post" action="{% url 'accounts:verify_otp' %}">
                                    {% csrf_token %}
                                    <!-- carry the email from the previous step -->
                                    <input type="hidden" name="email" id="otpEmailHidden" />

                                    <div class="tf-field style-1 mb_15">
                                        <input class="tf-field-input tf-input" placeholder="" type="text" name="code"
                                            minlength="6" maxlength="6" inputmode="numeric" pattern="[0-9]*" required>
                                        <label class="tf-field-label fw-4 text_black-2">OTP</label>
                                    </div>
                                    <div class="">
                                        <button type="submit"
                                            class="tf-btn w-100 radius-3 btn-fill animate-hover-btn justify-content-center"
                                            id="btnVerifyOtp">
                                            Login
                                        </button>
                                    </div>

                                    <div class="mt_16 text-center">
                                        <button type="button" class="tf-btn btn-line" id="btnChangeEmail">Change
                                            Email</button>
                                        <button type="button" class="tf-btn btn-line" id="btnResendOtp" disabled>Resend
                                            OTP in 60s</button>
                                    </div>

                                    <div class="mt_12 text-danger" id="otpError" style="display:none;"></div>
                                </form>
                            </div>
                        </div>

                        <!-- EMAIL / SEND OTP BLOCK (visible by default) -->
                        <div id="loginBlock">
                            <h5 class="mb_36">Log in</h5>
                            <p class="mb_30">We will send you a one-time OTP to your email.</p>
                            <div>
                                <form id="requestOtpForm" method="post" action="{% url 'accounts:request_otp' %}">
                                    {% csrf_token %}
                                    <div class="tf-field style-1 mb_15">
                                        <input class="tf-field-input tf-input" placeholder="" type="email"
                                            id="loginEmailInput" name="email" required>
                                        <label class="tf-field-label fw-4 text_black-2" for="loginEmailInput">Email
                                            *</label>
                                    </div>
                                    <div class="">
                                        <button type="submit"
                                            class="tf-btn w-100 radius-3 btn-fill animate-hover-btn justify-content-center"
                                            id="btnSendOtp">
                                            Send OTP
                                        </button>
                                    </div>
                                    <div class="mt_12 text-danger" id="emailError" style="display:none;"></div>
                                </form>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>
        <!-- page-cart -->

        <style>
            .is-hidden {
                display: none;
            }
        </style>

{% endblock %}


{% block models %}
<!-- toolbar-bottom -->
{% include 'partials/mobile-bottombar.html' %}
<!-- /toolbar-bottom -->
{% endblock %}

{% block js %}

    <script>
        (function () {
            // --- Elements
            const loginBlock = document.getElementById('loginBlock');
            const otpBlock = document.getElementById('otpBlock');
            const requestForm = document.getElementById('requestOtpForm');
            const verifyForm = document.getElementById('verifyOtpForm');
            const loginEmail = document.getElementById('loginEmailInput');
            const otpEmailHidden = document.getElementById('otpEmailHidden');
            const emailError = document.getElementById('emailError');
            const otpError = document.getElementById('otpError');
            const btnSendOtp = document.getElementById('btnSendOtp');
            const btnVerifyOtp = document.getElementById('btnVerifyOtp');
            const btnChangeEmail = document.getElementById('btnChangeEmail');
            const btnResendOtp = document.getElementById('btnResendOtp');

            // --- CSRF token from cookie
            function readCookie(name) {
                const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
                return m ? m.pop() : '';
            }
            const csrfToken = readCookie('csrftoken');

            // --- Helpers
            function show(el) { el.classList.remove('is-hidden'); el.setAttribute('aria-hidden', 'false'); }
            function hide(el) { el.classList.add('is-hidden'); el.setAttribute('aria-hidden', 'true'); }
            function setErr(el, msg) {
                if (!el) return;
                if (msg) { el.textContent = msg; el.style.display = 'block'; }
                else { el.textContent = ''; el.style.display = 'none'; }
            }
            function disable(el, yes) { if (el) el.disabled = !!yes; }

            // --- Toggle to OTP view with email carry-over
            function gotoOtpView(email) {
                otpEmailHidden.value = email;
                hide(loginBlock);
                show(otpBlock);
                startResendTimer();
            }

            // --- Resend cooldown (60s)
            let resendTimer = null, left = 60;
            function startResendTimer() {
                disable(btnResendOtp, true);
                left = 60;
                btnResendOtp.textContent = 'Resend OTP in 60s';
                if (resendTimer) clearInterval(resendTimer);
                resendTimer = setInterval(() => {
                    left -= 1;
                    if (left <= 0) {
                        clearInterval(resendTimer);
                        btnResendOtp.textContent = 'Resend OTP';
                        disable(btnResendOtp, false);
                    } else {
                        btnResendOtp.textContent = 'Resend OTP in ' + left + 's';
                    }
                }, 1000);
            }

            // --- Request OTP (Send)
            if (requestForm) {
                requestForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    setErr(emailError, '');
                    const email = (loginEmail.value || '').trim().toLowerCase();
                    if (!email) { setErr(emailError, 'Please enter a valid email.'); return; }

                    disable(btnSendOtp, true);
                    try {
                        const fd = new FormData(requestForm);
                        const res = await fetch(requestForm.action, {
                            method: 'POST',
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken },
                            body: fd
                        });
                        const data = await res.json();
                        if (data.ok) {
                            // success â†’ move to OTP screen
                            gotoOtpView(email);
                        } else {
                            setErr(emailError, data.message || 'Failed to send OTP.');
                        }
                    } catch (err) {
                        setErr(emailError, 'Network error. Please try again.');
                    } finally {
                        disable(btnSendOtp, false);
                    }
                });
            }

            // --- Verify OTP (Login)
            if (verifyForm) {
                verifyForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    setErr(otpError, '');
                    disable(btnVerifyOtp, true);
                    try {
                        const fd = new FormData(verifyForm);
                        const res = await fetch(verifyForm.action, {
                            method: 'POST',
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken },
                            body: fd
                        });
                        const data = await res.json();
                        if (data.ok) {
                            // Redirect after successful login
                            // Change this to your desired page: checkout/cart/account
                            window.location.href = "/";
                        } else {
                            setErr(otpError, data.message || 'Invalid or expired OTP.');
                        }
                    } catch (err) {
                        setErr(otpError, 'Network error. Please try again.');
                    } finally {
                        disable(btnVerifyOtp, false);
                    }
                });
            }

            // --- Change email (go back)
            if (btnChangeEmail) {
                btnChangeEmail.addEventListener('click', function () {
                    show(loginBlock);
                    hide(otpBlock);
                    setErr(emailError, ''); setErr(otpError, '');
                });
            }

            // --- Resend OTP
            if (btnResendOtp) {
                btnResendOtp.addEventListener('click', async function () {
                    if (btnResendOtp.disabled) return;
                    const email = otpEmailHidden.value;
                    if (!email) return;

                    disable(btnResendOtp, true);
                    try {
                        const fd = new FormData();
                        fd.append('email', email);
                        // POST to the same request_otp endpoint
                        const res = await fetch("{% url 'accounts:request_otp' %}", {
                            method: 'POST',
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken },
                            body: fd
                        });
                        const data = await res.json();
                        if (data.ok) {
                            startResendTimer();
                        } else {
                            // If throttle kicks, keep button disabled briefly
                            setErr(otpError, data.message || 'Unable to resend OTP right now.');
                            setTimeout(() => disable(btnResendOtp, false), 4000);
                        }
                    } catch (err) {
                        setErr(otpError, 'Network error. Please try again.');
                        disable(btnResendOtp, false);
                    }
                });
            }

            // --- Enter key UX: move focus
            const codeInput = verifyForm ? verifyForm.querySelector('input[name="code"]') : null;
            if (codeInput) {
                codeInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        btnVerifyOtp.click();
                    }
                });
            }
        })();
    </script>
{% endblock %}